<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026新年快乐</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            overflow: hidden; 
            background: #000; 
            font-family: "Microsoft YaHei", "SimHei", Arial, sans-serif;
        }
        #fireworkCanvas { 
            display: block; 
            background: #000; 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 1; 
            width: 100vw; 
            height: 100vh;
        }
        /* 倒计时/2026数字画布：严格居中，视觉核心区 */
        #countdownCanvas { 
            position: fixed; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5; 
            display: none;
            object-fit: contain;
            max-width: 90vw;
            max-height: 50vh;
        }
        /* 2026像素数字画布：独立画布，等宽放大 */
        #year2026Canvas {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 6;
            display: none;
            object-fit: contain;
            max-width: 95vw;
            max-height: 60vh;
        }
        .text-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            }
        .main-text {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -45%); /* 初始轻微上移 */
            margin: 0;
            color: #fff;
            font-size: clamp(24px, 7vw, 60px);
            font-weight: bold;
            text-shadow: 0 0 25px #ffd700, 0 0 50px #ff0000, 0 0 80px #ff0000;
            opacity: 0;
            transition: opacity 0.5s ease, transform 0.5s ease; /* 新增过渡属性 */
        }
        .main-text.active {
            opacity: 1;
            transform: translate(-50%, -50%); /* 激活后回到居中位置 */
        }
        /* 非激活状态文字轻微下移，形成位移过渡 */
        .main-text:not(.active) {
            transform: translate(-50%, -55%);
        }
        .control-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: clamp(12px, 3vw, 14px);
            opacity: 0.9;
            z-index: 20;
            background: rgba(0,0,0,0.7);
            padding: 6px 18px;
            border-radius: 12px;
            bottom: 20px !important;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .click-tip {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ffd700;
            font-size: 26px;
            text-shadow: 0 0 15px #ff0000, 0 0 30px #ff0000;
            z-index: 100;
            text-align: center;
            background: rgba(0,0,0,0.5);
            padding: 12px 24px;
            border-radius: 18px;
        }
        /* 顶部右侧图片样式：固定定位，避免被遮挡 */
        .top-right-image {
            position: fixed;
            top: 20px;
            right: 20px;
            width: clamp(80px, 25vw, 120px);
            z-index: 101;
        }
    </style>
</head>
<body>
    <img 
        class="top-right-image" 
        src="./春.png"
    >
    <div class="click-tip" id="clickTip">点击屏幕 → 启动音乐+倒计时+烟花</div>
    <canvas id="fireworkCanvas"></canvas>
    <canvas id="countdownCanvas"></canvas>
    <canvas id="year2026Canvas"></canvas>
    <div class="text-overlay" id="textOverlay">
        <div class="main-text" id="text0">新</div>
        <div class="main-text" id="text1">年</div>
        <div class="main-text" id="text2">快</div>
        <div class="main-text" id="text3">乐</div>
        <div class="main-text" id="text4">愿我们</div>
        <div class="main-text" id="text5">新的一年</div>
        <div class="main-text" id="text6">好运+1</div>
        <div class="main-text" id="text7">幸福+1</div>
        <div class="main-text" id="text8">健康+1</div>
        <div class="main-text" id="text9">财富+1</div>
        <div class="main-text" id="text10">平安喜乐</div>
        <div class="main-text" id="text11">万事顺利</div>
        <div class="main-text" id="text12">2026新年快乐!</div>
    </div>
    <div class="control-panel">
    空格=批量烟花 | F11=全屏 | ESC=退出全屏
    </div>
    <button id="restartBtn" style="
        position: fixed;
        top: 60%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 99;
        padding: 15px 40px;
        font-size: 24px;
        font-weight: bold;
        color: #fff;
        background: linear-gradient(#ffd700, #ff9900);
        border: none;
        border-radius: 50px;
        box-shadow: 0 0 20px #ff0000;
        cursor: pointer;
        display: none;
    ">
        重新开始
    </button>

    <script>
        // 像素数字点阵（7x9等宽设计，保证0/2/6视觉统一）
        const pixelDigits = {
            5: [[1,1,1,1,1,1,1],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,1,1,1,1,1,1],[0,0,0,0,0,0,1],[0,0,0,0,0,0,1],[1,1,1,1,1,1,1],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]],
            4: [[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,1,1,1,1,1,1],[0,0,0,0,0,0,1],[0,0,0,0,0,0,1],[0,0,0,0,0,0,1],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]],
            3: [[1,1,1,1,1,1,1],[0,0,0,0,0,0,1],[0,0,0,0,0,0,1],[1,1,1,1,1,1,1],[0,0,0,0,0,0,1],[0,0,0,0,0,0,1],[1,1,1,1,1,1,1],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]],
            2: [[1,1,1,1,1,1,1],[0,0,0,0,0,0,1],[0,0,0,0,0,0,1],[1,1,1,1,1,1,1],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,1,1,1,1,1,1],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]],
            1: [[0,0,0,0,0,0,1],[0,0,0,0,0,0,1],[0,0,0,0,0,0,1],[0,0,0,0,0,0,1],[0,0,0,0,0,0,1],[0,0,0,0,0,0,1],[0,0,0,0,0,0,1],[0,0,0,0,0,0,1],[0,0,0,0,0,0,1]],
            0: [[1,1,1,1,1,1,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,1,1,1,1,1,1],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]],
            6: [[1,1,1,1,1,1,1],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[1,1,1,1,1,1,1],[1,0,0,0,0,0,1],[1,0,0,0,0,0,1],[1,1,1,1,1,1,1],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]]
        };

        // 倒计时渐变相关变量（仅用于5-1倒计时，2026无渐变）
        let countdownBrightness = 0;
        const brightnessStep = 0.09;
        let isCountdownFading = false;

        // 设备判断：是否为移动端（屏幕宽度<768px）
        const isMobile = window.innerWidth < 768;

        // 核心配置参数（统一管理，方便修改）
        const cfg = {
            digitSize: isMobile ? 40 : 50,
            yearDigitSize: isMobile ? 300 : 400,
            color: '#ffd700',
            glow: '#ff9900',
            year2026Color: '#ff0000',
            year2026Glow: '#ff3333',
            interval: 0.8,
            startT: 4.5,
            fireworkRate: isMobile ? 0.02 : 0.03,
            yearShowTime: 8000,
            digitGap: 3,
            scaleRatio: isMobile ? 1.0 : 1.2
        };

        // 自动生成倒计时时间轴（5→4→3→2→1→结束）
        cfg.timeline = [
            {t: cfg.startT, d: 5},
            {t: cfg.startT + cfg.interval, d: 4},
            {t: cfg.startT + cfg.interval*2, d: 3},
            {t: cfg.startT + cfg.interval*3, d: 2},
            {t: cfg.startT + cfg.interval*4, d: 1},
            {t: cfg.startT + cfg.interval*5, d: null}
        ];

        // 全局元素初始化（获取页面DOM元素和画布上下文）
        const [fwCanvas, fwCtx] = [document.getElementById('fireworkCanvas'), document.getElementById('fireworkCanvas').getContext('2d')];
        const [cdCanvas, cdCtx] = [document.getElementById('countdownCanvas'), document.getElementById('countdownCanvas').getContext('2d')];
        const [yearCanvas, yearCtx] = [document.getElementById('year2026Canvas'), document.getElementById('year2026Canvas').getContext('2d')];
        const [textOverlay, clickTip] = [document.getElementById('textOverlay'), document.getElementById('clickTip')];
        const textEls = Array.from(document.querySelectorAll('.main-text'));
        const restartBtn = document.getElementById('restartBtn');
        let [isInited, isCdEnd, isYearShow, cdIdx, textIdx, textTime, yearShowStart] = [false, false, false, 0, 0, 0, 0];
        let isFinished = false;

        // 顶部图片加载容错（加载失败隐藏，避免占位符影响视觉）
        const springImg = document.querySelector('.top-right-image');
        springImg.onerror = function() {
            this.style.display = 'none';
        };

        // 背景音乐初始化
        const audio = new Audio("./终会与你同行.mp3"); 
        audio.loop = false; audio.volume = 0.9; audio.preload = 'auto';

        // 音乐加载状态提示（就绪/失败分别更新提示文字）
        audio.oncanplaythrough = function() {
            clickTip.textContent = '点击屏幕 → 启动音乐+倒计时+烟花（音乐已就绪）';
        };
        audio.onerror = function() {
            clickTip.textContent = '点击屏幕 → 启动倒计时+烟花（音乐加载失败）';
        };

        // 烟花配置（文字列表+配色方案）
        const fwTexts = ["5","4","3","2","1","2026","新","年","快","乐","2026新年快乐"];
        const colors = ['#ff0000','#ff6600','#ffd700','#ffff00','#00ff00','#00ffff','#9900ff','#ffffff'];
        let fireworks = [];

        // 画布自适应函数（窗口缩放时重置画布大小，保证元素居中不变形）
        function resize() {
            // 烟花画布适配
            fwCanvas.width = window.innerWidth;
            fwCanvas.height = window.innerHeight;

            // 倒计时画布适配
            const cdScale = Math.min(window.innerWidth, window.innerHeight) * 0.3 / (7 * cfg.digitSize);
            cdCanvas.width = 7 * cfg.digitSize * cdScale * window.devicePixelRatio;
            cdCanvas.height = 9 * cfg.digitSize * cdScale * window.devicePixelRatio;
            cdCanvas.style.width = `${7 * cfg.digitSize * cdScale}px`;
            cdCanvas.style.height = `${9 * cfg.digitSize * cdScale}px`;
            cdCtx.scale(window.devicePixelRatio, window.devicePixelRatio);

            // 2026画布适配（等宽放大，预留数字间距）
            const totalWidth = 4 * (7 + cfg.digitGap) * cfg.yearDigitSize;
            const yearScale = Math.min(window.innerWidth, window.innerHeight) * cfg.scaleRatio / totalWidth;
            yearCanvas.width = totalWidth * yearScale * window.devicePixelRatio;
            yearCanvas.height = 9 * cfg.yearDigitSize * yearScale * window.devicePixelRatio;
            yearCanvas.style.width = `${totalWidth * yearScale}px`;
            yearCanvas.style.height = `${9 * cfg.yearDigitSize * yearScale}px`;
            yearCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
        }
        resize(); 
        window.addEventListener('resize', resize);

        // 绘制单个倒计时数字（带金色→白色渐变效果）
        function drawDigit(d) {
            const scale = Math.min(window.innerWidth, window.innerHeight) * 0.3 / (7 * cfg.digitSize);
            cdCtx.clearRect(0, 0, cdCanvas.width/window.devicePixelRatio, cdCanvas.height/window.devicePixelRatio);
            
            // 计算渐变颜色值
            const baseColor = cfg.color.replace('#', '');
            const r = parseInt(baseColor.slice(0, 2), 16) + Math.floor(countdownBrightness * (255 - parseInt(baseColor.slice(0, 2), 16)));
            const g = parseInt(baseColor.slice(2, 4), 16) + Math.floor(countdownBrightness * (255 - parseInt(baseColor.slice(2, 4), 16)));
            const b = parseInt(baseColor.slice(4, 6), 16) + Math.floor(countdownBrightness * (255 - parseInt(baseColor.slice(4, 6), 16)));
            
            // 计算发光效果渐变
            const glowColor = cfg.glow.replace('#', '');
            const glowR = parseInt(glowColor.slice(0, 2), 16) + Math.floor(countdownBrightness * (255 - parseInt(glowColor.slice(0, 2), 16)));
            const glowG = parseInt(glowColor.slice(2, 4), 16) + Math.floor(countdownBrightness * (255 - parseInt(glowColor.slice(2, 4), 16)));
            const glowB = parseInt(glowColor.slice(4, 6), 16) + Math.floor(countdownBrightness * (255 - parseInt(glowColor.slice(4, 6), 16)));
            
            cdCtx.shadowColor = `rgb(${glowR}, ${glowG}, ${glowB})`; 
            cdCtx.shadowBlur = 30 * scale + countdownBrightness * 20 * scale; 
            cdCtx.fillStyle = `rgb(${r}, ${g}, ${b})`;
            
            // 遍历点阵绘制数字
            pixelDigits[d].forEach((row, y) => {
                row.forEach((dot, x) => {
                    if (dot) cdCtx.fillRect(
                        x * cfg.digitSize * scale, 
                        y * cfg.digitSize * scale, 
                        (cfg.digitSize - 4) * scale, 
                        (cfg.digitSize - 4) * scale
                    );
                });
            });
            
            // 更新渐变亮度（循环直到纯白）
            if (isCountdownFading && countdownBrightness < 1) {
                countdownBrightness += brightnessStep;
                if (countdownBrightness > 1) countdownBrightness = 1;
                requestAnimationFrame(() => drawDigit(d));
            }
        }

        // 绘制2026像素数字（等宽放大，霓虹渐变效果，无渐变）
        function draw2026() {
            const totalWidth = 4 * (7 + cfg.digitGap) * cfg.yearDigitSize;
            const scale = Math.min(window.innerWidth, window.innerHeight) * cfg.scaleRatio / totalWidth;
            yearCtx.clearRect(0, 0, yearCanvas.width/window.devicePixelRatio, yearCanvas.height/window.devicePixelRatio);
            
            // 创建线性渐变（红→金→红）
            const gradient = yearCtx.createLinearGradient(0, 0, totalWidth * scale, 0);
            gradient.addColorStop(0, '#ff0000');
            gradient.addColorStop(0.5, '#ffd700');
            gradient.addColorStop(1, '#ff0000');
            
            // 设置发光效果和填充样式
            yearCtx.shadowColor = '#ff3333';
            yearCtx.shadowBlur = 60 * scale;
            yearCtx.fillStyle = gradient;
            
            // 遍历2026四个数字绘制
            const yearDigits = [2,0,2,6];
            yearDigits.forEach((digit, idx) => {
                const offsetX = idx * (7 + cfg.digitGap) * cfg.yearDigitSize * scale;
                pixelDigits[digit].forEach((row, y) => {
                    row.forEach((dot, x) => {
                        if (dot) yearCtx.fillRect(
                            offsetX + x * cfg.yearDigitSize * scale, 
                            y * cfg.yearDigitSize * scale, 
                            (cfg.yearDigitSize - 4) * scale, 
                            (cfg.yearDigitSize - 4) * scale
                        );
                    });
                });
            });
        }

        // 烟花粒子类（单个粒子的运动和渲染）
        class Particle {
            constructor(x, y, c, dx, dy) {
                this.x = x; this.y = y; this.c = c;
                this.life = Math.random()*80+60; this.maxL = this.life;
                this.s = Math.random()*3+2; 
                this.dx = dx; this.dy = dy; 
                this.g = 0.05; 
                this.decay = 0.96; 
            }
            update() {
                this.dy += this.g; 
                this.x += this.dx; 
                this.y += this.dy;
                this.dx *= this.decay; 
                this.dy *= this.decay;
                this.life--; 
                const alpha = this.life/this.maxL;
                fwCtx.beginPath(); 
                fwCtx.arc(this.x, this.y, this.s*alpha, 0, Math.PI*2);
                fwCtx.fillStyle = `${this.c}${Math.floor(alpha*255).toString(16).padStart(2, '0')}`; 
                fwCtx.fill();
                return this.life > 0;
            }
        }

        // 文字烟花类（支持传入指定文字，实现文字形状的烟花爆炸）
        class TextFirework {
            constructor(x = Math.random()*window.innerWidth, y = window.innerHeight, text = null) {
                this.x = x; this.y = y;
                this.text = text || fwTexts[Math.floor(Math.random()*fwTexts.length)];
                this.color = colors[Math.floor(Math.random()*colors.length)];
                this.speed = Math.random()*10+7; 
                this.targetY = Math.random()*(window.innerHeight/2)+80; 
                this.exploded = false; 
                this.particles = []; 
                this.genTextPath(); 
            }
            // 生成文字点阵路径（离线画布生成）
            genTextPath() {
                const tCanvas = document.createElement('canvas'); 
                const tCtx = tCanvas.getContext('2d');
                const fs = this.text.length>4 ? 50 : 70; 
                tCanvas.width = 300; 
                tCanvas.height = 300;
                tCtx.font = `bold ${fs}px SimHei`; 
                tCtx.textAlign = 'center'; 
                tCtx.textBaseline = 'middle';
                tCtx.fillText(this.text, 150, 150); 
                const data = tCtx.getImageData(0,0,300,300).data;
                for (let y=0; y<300; y+=5) {
                    for (let x=0; x<300; x+=5) {
                        if (data[(y*300+x)*4+3] > 128) {
                            this.particles.push([(x-150)/150, (y-150)/150]);
                        }
                    }
                }
            }
            // 烟花上升阶段
            rise() {
                fwCtx.beginPath(); 
                fwCtx.arc(this.x, this.y, 5, 0, Math.PI*2); 
                fwCtx.fillStyle = this.color; 
                fwCtx.fill();
                this.y -= this.speed; 
                if (this.y <= this.targetY) this.exploded = true;
            }
            // 烟花爆炸阶段（生成粒子）
            explode() {
                this.particles.forEach(([dx, dy]) => {
                    fireworks.push(new Particle(this.x, this.y, this.color, dx*Math.random()*8, dy*Math.random()*8));
                });
            }
            // 更新烟花状态（上升/爆炸切换）
            update() {
                this.exploded ? this.explode() : this.rise();
                return !this.exploded;
            }
        }

        // 主动画循环（核心流程：倒计时→2026→祝福文字→结束）
        function animate() {
            requestAnimationFrame(animate);
            fwCtx.fillStyle = 'rgba(0,0,0,0.09)'; 
            fwCtx.fillRect(0,0,fwCanvas.width,fwCanvas.height);

            if (isInited) {
                // 自动生成烟花（限制最大数量200，避免性能过载）
                if (Math.random() < cfg.fireworkRate && !isFinished && fireworks.length < 200) {
                    fireworks.push(new TextFirework());
                }
                // 更新所有烟花/粒子状态，过滤已消亡的元素
                fireworks = fireworks.filter(f => f.update ? f.update() : f.update());

                // 1. 倒计时阶段（5→4→3→2→1）
                if (!isCdEnd && !isFinished) {
                    const currentTime = audio.currentTime;
                    if (cdIdx < cfg.timeline.length) {
                        const {t, d} = cfg.timeline[cdIdx];
                        if (currentTime >= t) {
                            if (d) { 
                                cdCanvas.style.display = 'block'; 
                                isCountdownFading = true;
                                countdownBrightness = 0;
                                drawDigit(d); 
                            } else { 
                                // 倒计时结束，切换到2026显示
                                isCdEnd = true; 
                                isYearShow = true;
                                cdCanvas.style.display = 'none';
                                yearCanvas.style.display = 'block';
                                draw2026();
                                yearShowStart = Date.now();
                                
                                // 2026出现时生成大量烟花，增强氛围
                                for (let i = 0; i < 50; i++) {
                                    fireworks.push(new TextFirework(
                                        Math.random() * window.innerWidth,
                                        window.innerHeight + Math.random() * 100
                                    ));
                                }
                            }
                            cdIdx++;
                        }
                    }
                } 
                // 2. 2026数字显示阶段（指定时长后切换到祝福文字）
                else if (isYearShow && !isFinished) {
                    // 优先生成"2026"文字烟花，呼应当前视觉
                    if (Math.random() < 0.15) { 
                        fireworks.push(new TextFirework(undefined, undefined, '2026'));
                    }
                    if (Date.now() - yearShowStart > cfg.yearShowTime) {
                        isYearShow = false;
                        yearCanvas.style.display = 'none';
                        textOverlay.style.opacity = 1;
                        textEls[0].classList.add('active');
                        textTime = Date.now();
                    }
                }
                // 3. 祝福文字切换阶段（按预设时长轮播显示）
                else if (!isFinished) {
                    const textOrder = [0,1,2,3,4,5,6,7,8,9,10,11,12];
                    const durations = [800,800,800,800,1500,1500,1200,1200,1200,1500,1500,1500,0];
                    
                    if (durations[textIdx] > 0 && Date.now() - textTime > durations[textIdx]) {
                        textEls[textOrder[textIdx]].classList.remove('active');
                        textIdx++;
                        textTime = Date.now();
                        textEls[textOrder[textIdx]].classList.add('active');

                        // 最后一句且音乐结束，标记流程完成，显示重启按钮
                        if (textIdx >= 12 && audio.ended) {
                            isFinished = true;
                            restartBtn.style.display = 'block';
                        }
                    }
                }
            }
        }

        // 监听音乐播放结束事件（完成流程闭环）
        audio.addEventListener('ended', () => {
            if (textIdx >= 12) {
                isFinished = true;
                restartBtn.style.display = 'block';
            }
        });

        // 页面交互事件（点击启动/触发烟花）
        document.addEventListener('click', (e) => {
            if (!isInited && !isFinished) { 
                isInited = true; 
                clickTip.style.display = 'none'; 
                audio.play().catch(err => console.log('音乐播放失败：', err)); 
            } else if (!isFinished) {
                fireworks.push(new TextFirework(e.clientX, e.clientY));
            }
        });

        // 键盘交互事件（空格批量烟花/F11全屏/ESC退出全屏）
        document.addEventListener('keydown', (e) => {
            if (isInited && !isFinished) {
                if (e.code === 'Space') { 
                    e.preventDefault(); 
                    for (let i=0; i<15; i++) {
                        fireworks.push(new TextFirework());
                    }
                }
                if (e.code === 'F11') { 
                    e.preventDefault(); 
                    document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen(); 
                }
                if (e.code === 'Escape' && document.fullscreenElement) {
                    document.exitFullscreen();
                }
            }
        });

        // 重启按钮点击事件（重置所有状态，重新开始流程）
        restartBtn.addEventListener('click', () => {
            // 重置状态变量
            isInited = false;
            isCdEnd = false;
            isYearShow = false;
            isFinished = false;
            cdIdx = 0;
            textIdx = 0;
            textTime = 0;
            yearShowStart = 0;
            countdownBrightness = 0;
            isCountdownFading = false;
            
            // 清空烟花数组
            fireworks = [];
            
            // 重置页面元素显示状态
            restartBtn.style.display = 'none';
            clickTip.style.display = 'block';
            cdCanvas.style.display = 'none';
            yearCanvas.style.display = 'none';
            textOverlay.style.opacity = 0;
            textEls.forEach(el => el.classList.remove('active'));
            
            // 重置音乐播放进度
            audio.currentTime = 0;
        });

        // 启动主动画循环
        animate();
    </script>
</body>
</html>
